#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative "../lib/activeadmin_mitosis_editor/version"

module BumpVersion
  class << self
    def run(type = nil)
      current = ActiveAdminMitosisEditor::VERSION
      major, minor, patch = current.split(".").map(&:to_i)

      bump_type = type || detect_bump_type

      case bump_type
      when "major"
        major += 1
        minor = 0
        patch = 0
      when "minor"
        minor += 1
        patch = 0
      when "patch"
        patch += 1
      else
        puts "Usage: bump-version [major|minor|patch]"
        exit 1
      end

      new_version = "#{major}.#{minor}.#{patch}"
      update_version(new_version)
      new_version
    end

    private

    def detect_bump_type
      commits = `git log --oneline -10`.split("\n")
      has_major = commits.any? { |c| c.include?("feat!:") || c.include?("BREAKING") }
      has_fix = commits.any? { |c| c.include?("fix:") }
      has_minor = commits.any? { |c| c.include?("feat:") }

      return "major" if has_major
      return "minor" if has_minor
      return "patch" if has_fix

      "patch"
    end

    def update_version(new_version)
      file = "lib/activeadmin_mitosis_editor/version.rb"
      content = File.read(file)
      new_content = content.gsub(/VERSION = "[^"]+"/, "VERSION = \"#{new_version}\"")
      File.write(file, new_content)

      # Update CHANGELOG
      update_changelog(new_version)

      puts "Bumped version to #{new_version}"
    end

    def update_changelog(version)
      return unless File.exist?("CHANGELOG.md")

      date = Time.now.strftime("%Y-%m-%d")
      content = File.read("CHANGELOG.md")

      # Add new version section after "## [Unreleased]"
      unreleased = "## [Unreleased]"
      if content.include?(unreleased)
        new_section = "#{unreleased}\n\n## [#{version}] - #{date}\n\n### Added\n- "
        new_content = content.sub(unreleased, new_section)
        File.write("CHANGELOG.md", new_content)
      end
    end
  end
end

BumpVersion.run(ARGV[0])
