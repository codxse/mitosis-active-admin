<%
  theme = editor_options.fetch(:theme, 'auto')
%>
<%= render "inputs/mitosis_editor_input/dependencies", theme: theme %>

<div class="mitosis-editor-wrapper" data-editor-options="<%= editor_options.to_json %>">
  <div id="mitosis-editor-<%= input_html_options[:id] %>" class="mitosis-editor-container"></div>
</div>

<script>
(function() {
  var container = document.getElementById('mitosis-editor-<%= input_html_options[:id] %>');
  var wrapper = container.closest('.mitosis-editor-wrapper');
  var options = JSON.parse(wrapper.dataset.editorOptions || '{}');
  var hiddenInput = document.getElementById('<%= input_html_options[:id] %>');

  options.container = container;
  options.content = hiddenInput ? hiddenInput.value : '';

  if (window.Prism) {
    options.prism = window.Prism;
  }

  if (window.MitosisEditor && window.MitosisEditor.createEditor) {
    var editor = window.MitosisEditor.createEditor(options);

    if (options.theme === 'auto') {
      var htmlEl = document.documentElement;
      var mutationObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.attributeName === 'class') {
            var isDark = htmlEl.classList.contains('dark');
            editor.setTheme(isDark ? 'dark' : 'light');
          }
        });
      });
      mutationObserver.observe(htmlEl, { attributes: true });
    } else {
      editor.setTheme(options.theme);
    }

    var form = container.closest('form');
    if (form) {
      form.addEventListener('submit', function() {
        if (hiddenInput && editor && editor.getMarkdown) {
          hiddenInput.value = editor.getMarkdown();
        }
      });
    }
  }
})();
</script>
